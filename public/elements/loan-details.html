<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-styles/color.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">

<link rel="import" href="../behaviors/navigation-behavior.html">
<link rel="import" href="../behaviors/formatting-helper.html">

<dom-module id="loan-details">
  <template>
    <style>
      :host {
        display: block;
      }

      paper-card {
        width: 100%;
        height: 100%;
      }

      /* paper-button {
        color: var(--paper-purple-50);
      } */

      .bottom {
        position: absolute;
        bottom: 0px;
      }

      .controls {
        display: block;
        position: relative;
        margin: 10px auto;
        width: calc(100vw - 20px);
        max-width: 480px;
        @apply --layout-horizontal;
        @apply --layout-center;
        justify-content: space-between;
        transition: opacity 0.3s;
        opacity: 1;
      }

      .actions {
        position: fixed;
        bottom: 1em;
        right: 1em;
      }

      .toggle-btn-subtext {
        font-size: 12px;
        line-height: 24px;
        font-style: italic;
      }

      .toggle-btn-container {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
      }

.labels > div {
  margin-top: 40px;
}
      /* .label-details {
        @apply --layout-vertical;
      }
      .label-details > * {
        @apply --layout-horizontal;
        @apply --layout-horizontal;
      }
      .label-details label {
        @apply --layout-flex;
      } */
    </style>
    <firebase-document id="document" app-name="lumio" path="[[_dbDataPath(routeData)]]" data="{{dbData}}">
    </firebase-document>

    <app-route id="router" route="{{route}}" pattern="/:loanId" data="{{routeData}}" tail="{{subRoute}}">
    </app-route>


    <paper-card elevation="0">
      <div class="layout vertical flex">
        <div class="layout horizontal flex">
          <h3 class="flex">{{viewData.name}}</h3>
          <h3>&#8377; [[formatNumber(viewData.amount)]]</h3>
          <paper-menu-button>
              <paper-icon-button icon="menu" class="dropdown-trigger" slot="dropdown-trigger" alt="menu"></paper-icon-button>
              <paper-listbox class="dropdown-content" slot="dropdown-content">
                <paper-item>Edit</paper-item>
                <paper-item>Delete</paper-item>
                <paper-item>Repay</paper-item>
                <paper-item>Pay Interest</paper-item>
              </paper-listbox>
            </paper-menu-button>
          </div>
        <paper-tabs selected={{selectedTab}}>
          <paper-tab>Details</paper-tab>
          <paper-tab>Interests</paper-tab>
          <paper-tab>Payments</paper-tab>
        </paper-tabs>

        <neon-animated-pages selected={{selectedTab}}>
          <div class="layout vertical labels">
            <div class="layout horizontal flex">
              <label class="layout flex">Interest Rate</label>
              <label>[[viewData.interestRate]]%</label>
            </div>
            <div class="layout horizontal flex">
              <label class="layout flex">Frequency</label>
              <label>[[viewData.interestFrequency]]</label>
            </div>
            <div class="layout horizontal flex">
              <label class="layout flex">Start Date</label>
              <label>[[formatDate(viewData.startDate)]]</label>
            </div>
            <div class="layout horizontal flex">
              <label class="layout flex">Penalty</label>
              <label>[[_getPenaltyText(viewData)]]</label>
            </div>
            <div class="layout horizontal flex">
              <label class="layout flex">Accrued Interest</label>
              <label>&#8377;&nbsp;&nbsp;[[formatNumber(schedule.accrued.value)]]</label>
            </div>
          </div>
          <div class="layout vertical">
            <template is="dom-repeat" sort="sortItems" items=[[schedule.interests]]>
              <paper-item>
                  <label class="layout flex">[[formatDate(item.date)]]</label>
                  <label>&#8377; [[formatNumber(item.value)]]</label>    
              </paper-item>
            </template>            
          </div>
          <div class="layout vertical">
              <paper-fab class="actions" icon="add" on-tap="newPayment" disabled="[[!online]]" aria-label="Add note">
                </paper-fab>
        
          </div>
        </neon-animated-pages>
      </div>
    </paper-card>

    <!--
      <div class="layout vertical flex">

       <div class="fields">
        <oe-input required label="Name" field-id="name" value={{viewData.name}}></oe-input>
        <oe-decimal required min=1 label="Amount" field-id="amount" value={{viewData.amount}}>
          <span prefix>&#8377;&nbsp;&nbsp;</span>
        </oe-decimal>
      </div>
      <div class="actions controls">
        <paper-button on-tap="cancel">Cancel</paper-button>
        <paper-button disabled=[[!online]] on-tap="save">Save</paper-button>
      </div>
    </div> -->
  </template>
  <script>
    Polymer({
      is: 'loan-details',
      behaviors: [Polymer.FormattingHelper, Polymer.NavigationBehavior, Polymer.AppNetworkStatusBehavior],
      properties: {
        selectedTab:{
          type: Number,
          value: 0
        },
        basePath: {
          type: String
        },
        route: {
          type: Object
        },
        dbData: {
          type: Object,
          observer: '_dbDataChanged'
        },
        viewData: {
          type: Object,
          notify: true,
          value: this.emptyData
        }
      },
      emptyData: function () {
        return {}
      },
      sortItems: function(a, b){
        return a.date < b.date;
      },
      _getPenaltyText: function (loan) {
        if (loan.hasPenalty) {
          if (loan.penaltyType === 'Fixed Amount') {
            return 'â‚¹ ' + this.formatNumber(loan.penaltyRate) + ' Per Day';
          } else {
            return this.formatNumber(loan.penaltyRate) + '% Per Day';
          }
        } else {
          return 'None';
        }
      },
      _penaltyIsFixed: function (penaltyType) {
        return penaltyType === 'Fixed Amount';
      },
      _dbDataChanged: function (dbData) {
        /* Set on the view */
        if (this.$.document.path) {
          this.set('viewData', JSON.parse(JSON.stringify(dbData)));
          var now = new Date();
          var today = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
          this.set('schedule', Interest.generateSchedule(this.viewData, today));
        } else {
          this.set('viewData', this.emptyData());
          this.set('schedule', {});
        }

      },
      _dbDataPath: function (routeData) {
        return routeData && routeData.loanId ? (this.basePath + '/' + routeData.loanId) : undefined;
      },
      save: function () {
        var self = this;
        self.validateForm().then(function (state) {
          if (state.valid) {
            if (self.$.document.isNew) {
              self.$.document.data = JSON.parse(JSON.stringify(self.viewData));
              return self.$.document.saveValue(self.basePath).then(function () {
                self.$.document.reset();
                self.navigate('/');
              }.bind(this));
            } else {
              self.$.document.setStoredValue(self.$.document.path, JSON.parse(JSON.stringify(self.viewData)))
                .then(function () {
                  self.$.document.reset();
                  self.navigate('/');
                });
            }
          }
        });
      },
      cancel: function (detail) {
        this.$.document.reset();
        this.navigate('/');
      }
    });
  </script>
</dom-module>